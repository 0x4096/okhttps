<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基础 | OkHttps</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="OkHttps 请求方法 回调函数 HttpResult cache 多次 消费报文体 HttpCall 构建HTTP任务 请求参数 JSON 使用标签 发起请求 取消请求">
    <meta property="article:modified_time" content="2020-04-28T11:52:32.000Z">
    <meta property="og:site_name" content="OkHttps">
    <meta property="og:title" content="基础">
    <meta property="og:description" content="OkHttps 请求方法 回调函数 HttpResult cache 多次 消费报文体 HttpCall 构建HTTP任务 请求参数 JSON 使用标签 发起请求 取消请求">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/guide/foundation.html">
    <meta name="twitter:title" content="基础">
    <meta name="twitter:description" content="OkHttps 请求方法 回调函数 HttpResult cache 多次 消费报文体 HttpCall 构建HTTP任务 请求参数 JSON 使用标签 发起请求 取消请求">
    <meta name="twitter:url" content="/guide/foundation.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:label1" content="Written by">
    <link rel="preload" href="/assets/css/0.styles.86d9e6f9.css" as="style"><link rel="preload" href="/assets/js/app.1e2fa6f5.js" as="script"><link rel="preload" href="/assets/js/2.16cbe9f2.js" as="script"><link rel="preload" href="/assets/js/11.152d132f.js" as="script"><link rel="prefetch" href="/assets/js/10.bc5e580e.js"><link rel="prefetch" href="/assets/js/12.92e24a16.js"><link rel="prefetch" href="/assets/js/13.d857e269.js"><link rel="prefetch" href="/assets/js/3.972ca2ed.js"><link rel="prefetch" href="/assets/js/4.fe3bf0b0.js"><link rel="prefetch" href="/assets/js/5.93d38f11.js"><link rel="prefetch" href="/assets/js/6.fd474f39.js"><link rel="prefetch" href="/assets/js/7.51e5642d.js"><link rel="prefetch" href="/assets/js/8.d296d289.js"><link rel="prefetch" href="/assets/js/9.bff804f8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.86d9e6f9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="OkHttps" class="logo"> <span class="site-name can-hide">OkHttps</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  教程
</a></div><div class="nav-item"><a href="https://gitee.com/ejlchina-zhxu/okhttps/releases" target="_blank" rel="noopener noreferrer" class="nav-link external">
  历史版本
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="http://grails.ejlchina.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Grails 中文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://gitee.com/ejlchina-zhxu/okhttps" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/ejlchina/okhttps" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  教程
</a></div><div class="nav-item"><a href="https://gitee.com/ejlchina-zhxu/okhttps/releases" target="_blank" rel="noopener noreferrer" class="nav-link external">
  历史版本
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="http://grails.ejlchina.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Grails 中文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://gitee.com/ejlchina-zhxu/okhttps" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/ejlchina/okhttps" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/guide/" class="sidebar-link">起步</a></li><li><a href="/guide/foundation.html" class="active sidebar-link">基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/foundation.html#请求方法" class="sidebar-link">请求方法</a></li><li class="sidebar-sub-header"><a href="/guide/foundation.html#回调函数" class="sidebar-link">回调函数</a></li><li class="sidebar-sub-header"><a href="/guide/foundation.html#httpresult" class="sidebar-link">HttpResult</a></li><li class="sidebar-sub-header"><a href="/guide/foundation.html#httpcall" class="sidebar-link">HttpCall</a></li><li class="sidebar-sub-header"><a href="/guide/foundation.html#构建http任务" class="sidebar-link">构建HTTP任务</a></li><li class="sidebar-sub-header"><a href="/guide/foundation.html#使用标签" class="sidebar-link">使用标签</a></li></ul></li><li><a href="/guide/configuration.html" class="sidebar-link">配置</a></li><li><a href="/guide/features.html" class="sidebar-link">特色</a></li><li><a href="/guide/updown.html" class="sidebar-link">上传下载</a></li><li><a href="/guide/android.html" class="sidebar-link">安卓</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="基础"><a href="#基础" class="header-anchor">#</a> 基础</h1> <h2 id="请求方法"><a href="#请求方法" class="header-anchor">#</a> 请求方法</h2> <p>同步与异步的<code>HttpTask</code>都拥有<code>get</code>、<code>post</code>、<code>put</code>与<code>delete</code>方法。不同的是：同步<code>HttpTask</code>的这些方法返回一个<code>HttpResult</code>，而异步<code>HttpTask</code>的这些方法返回一个<code>HttpCall</code>。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">HttpResult</span> res1 <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 同步 GET</span>
<span class="token class-name">HttpResult</span> res2 <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 同步 POST</span>
<span class="token class-name">HttpResult</span> res3 <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">&quot;/users/1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 同步 PUT</span>
<span class="token class-name">HttpResult</span> res4 <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">&quot;/users/1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 同步 DELETE</span>
<span class="token class-name">HttpCall</span> call1 <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 异步 GET</span>
<span class="token class-name">HttpCall</span> call2 <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 异步 POST</span>
<span class="token class-name">HttpCall</span> call3 <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token string">&quot;/users/1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 异步 PUT</span>
<span class="token class-name">HttpCall</span> call4 <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token string">&quot;/users/1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 异步 DELETE</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="回调函数"><a href="#回调函数" class="header-anchor">#</a> 回调函数</h2> <p>OkHttps 的回调函数全部使用单方法模式，这样可以充分利用 Java8 或 Kotlin 中的 Lambda 表达式，使你的代码更加简洁优雅：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>http<span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token string">&quot;/users/{id}&quot;</span><span class="token punctuation">)</span>             <span class="token comment">// http://api.demo.com/users/1</span>
        <span class="token punctuation">.</span><span class="token function">addPathParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setOnResponse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpResult</span> result<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 响应回调</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setOnException</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 异常回调</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setOnComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">State</span> state<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 完成回调，无论成功失败都会执行</span>
            <span class="token comment">// 并且在 响应|异常回调 之前执行</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>OkHttps 同时还支持 <strong>全局回调</strong> 和 <strong>回调阻断</strong> 机制，详见 <a href="/guide/configuration.html#全局回调监听">全局回调监听</a>。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <ul><li>只有异步请求才可以设置这三种（响应|异常|完成）回调</li> <li>同步请求直接返回结果，无需使用回调</li></ul></div> <h2 id="httpresult"><a href="#httpresult" class="header-anchor">#</a> HttpResult</h2> <p><code>HttpResult</code>是HTTP请求执行完后的结果，它是同步请求方法（ <code>get</code>、<code>post</code>、<code>put</code>、<code>delete</code>）的返回值，也是异步请求响应回调（<code>OnResponse</code>）的参数，它定义了如下方法：</p> <ul><li><code>getState()</code>         得到请求执行状态枚举，它有以下取值：
<ul><li><code>State.CANCELED</code>      请求被取消</li> <li><code>State.RESPONSED</code>     已收到响应</li> <li><code>State.TIMEOUT</code>       请求超时</li> <li><code>State.NETWORK_ERROR</code> 网络错误</li> <li><code>State.EXCEPTION</code>     其它请求异常</li></ul></li> <li><code>getStatus()</code>        得到HTTP状态码</li> <li><code>isSuccessful()</code>     是否响应成功，状态码在 [200..300) 之间</li> <li><code>getHeaders()</code>       得到HTTP响应头</li> <li><code>getHeaders(String name)</code> 得到HTTP响应头</li> <li><code>getHeader(String name)</code>  得到HTTP响应头</li> <li><code>getBody()</code>          得到响应报文体<code>Body</code>实例，它定义了如下方法（对同一个<code>Body</code>实例，以下的<code>toXXX()</code>类方法只能使用一个且仅能调用一次，除非先使用 cache 方法）：
<ul><li><code>toBytes()</code>                     返回字节数组</li> <li><code>toByteStream()</code>                返回字节输入流</li> <li><code>toCharStream()</code>                返回字符输入流</li> <li><code>toString()</code>                    返回字符串</li> <li><code>toJsonObject()</code>                返回Json对象</li> <li><code>toJsonArray()</code>                 返回Json数组</li> <li><code>toBean(Class&lt;T&gt; type)</code>         返回根据type自动json解析后的JavaBean</li> <li><code>toList(Class&lt;T&gt; type)</code>         返回根据type自动json解析后的JavaBean列表</li> <li><code>toFile(String filePath)</code>       下载到指定路径</li> <li><code>toFile(File file)</code>             下载到指定文件</li> <li><code>toFolder(String dirPath)</code>      下载到指定目录</li> <li><code>toFolder(File dir)</code>            下载到指定目录</li> <li><code>getContentType()</code>              返回报文体的媒体类型</li> <li><code>getContentLength()</code>            返回报文体的字节长度</li> <li><code>cache()</code>                       缓存报文体，开启缓存后可重复使用<code>toXXX()</code>类方法</li> <li><code>close()</code>                       关闭报文体，未对报文体做任何消费时使用，比如只读取报文头</li></ul></li> <li><code>getError()</code>         执行中发生的异常，自动捕获执行请求时发生的 网络超时、网络错误 和 其它IO异常</li> <li><code>close()</code>            关闭报文，未对报文体做任何消费时使用，比如只读取长度</li></ul> <p>示例，请求结果自动转Bean和List：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 自动转Bean</span>
<span class="token class-name">Order</span> order <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">&quot;/orders/1&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token comment">// 自动转List</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">&gt;</span></span> orders <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">&quot;/orders&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>示例，使用 cache 方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Body</span> body <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">&quot;/orders&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用 cache 后，可以多次使用 toXXX() 方法</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">toJsonArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>示例，获取下载文件的大小：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">long</span> size <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">&quot;/download/test.zip&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             <span class="token comment">// 只是想获得文件大小，不消费报文体，所以直接关闭</span>
            <span class="token punctuation">.</span><span class="token function">getContentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获得待下载文件的大小</span>

<span class="token comment">// 由于未消费报文体，所以本次请求不会消耗下载报文体的时间和网络流量</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;size = &quot;</span> <span class="token operator">+</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="httpcall"><a href="#httpcall" class="header-anchor">#</a> HttpCall</h2> <p><code>HttpCall</code>对象是异步请求方法（<code>get</code>、<code>post</code>、<code>put</code>、<code>delete</code>）的返回值，与<code>java</code>的<code>Future</code>接口很像，它有如下方法：</p> <ul><li><code>cancel()</code> 取消本次请求，返回取消结果</li> <li><code>isCanceled()</code> 返回请求是否被取消</li> <li><code>isDone()</code> 返回是否执行完成，包含取消和失败</li> <li><code>getResult()</code> 返回执行结果<code>HttpResult</code>对象，若请求未执行完，则挂起当前线程直到执行完成再返回</li></ul> <p>取消一个异步请求示例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">HttpCall</span> call <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token string">&quot;/users/1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>call<span class="token punctuation">.</span><span class="token function">isCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// false</span>

<span class="token keyword">boolean</span> success <span class="token operator">=</span> call<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 取消请求</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// true</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>call<span class="token punctuation">.</span><span class="token function">isCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="构建http任务"><a href="#构建http任务" class="header-anchor">#</a> 构建HTTP任务</h2> <p><code>HTTP</code>对象的<code>sync</code>与<code>async</code>方法返回一个<code>HttpTask</code>对象，该对象提供了可链式调用的<code>addXXX</code>与<code>setXXX</code>等系列方法用于构建任务本身。</p> <ul><li><p><code>addHeader(String name, String value)</code>    添加请求头</p></li> <li><p><code>addHeader(Map&lt;String, String&gt; headers)</code>  添加请求头</p></li> <li><p><code>addPathParam(String name, Object value)</code> 添加路径参数：替换URL里的{name}占位符</p></li> <li><p><code>addPathParam(Map&lt;String, ?&gt; params)</code>     添加路径参数：替换URL里的{name}占位符</p></li> <li><p><code>addUrlParam(String name, Object value)</code>  添加URL参数：拼接在URL的?之后（查询参数）</p></li> <li><p><code>addUrlParam(Map&lt;String, ?&gt; params)</code>      添加URL参数：拼接在URL的?之后（查询参数）</p></li> <li><p><code>addBodyParam(String name, Object value)</code> 添加Body参数：以表单key=value&amp;的形式放在报文体内（表单参数）</p></li> <li><p><code>addBodyParam(Map&lt;String, ?&gt; params)</code>     添加Body参数：以表单key=value&amp;的形式放在报文体内（表单参数）</p></li> <li><p><code>addJsonParam(String name, Object value)</code> 添加Json参数：请求体为Json（支持多层结构）</p></li> <li><p><code>addJsonParam(Map&lt;String, ?&gt; params)</code>     添加Json参数：请求体为Json（支持多层结构）</p></li> <li><p><code>setRequestJson(Object json)</code>             设置请求体的Json字符串 或待转换为 Json的 JavaBean</p></li> <li><p><code>setRequestJson(Object bean, String dateFormat)</code> 设置请求体的Json字符串 或待转换为 Json的 JavaBean</p></li> <li><p><code>addFileParam(String name, String filePath)</code> 上传文件</p></li> <li><p><code>addFileParam(String name, File file)</code> 上传文件</p></li> <li><p><code>addFileParam(String name, String type, InputStream inputStream)</code> 上传文件</p></li> <li><p><code>addFileParam(String name, String type, String fileName, InputStream input)</code> 上传文件</p></li> <li><p><code>addFileParam(String name, String type, byte[] content)</code> 上传文件</p></li> <li><p><code>addFileParam(String name, String type, String fileName, byte[] content)</code> 上传文件</p></li> <li><p><code>setTag(String tag)</code> 为HTTP任务添加标签</p></li> <li><p><code>setRange(long rangeStart)</code> 设置Range头信息，用于<a href="/guide/updown.html#实现断点续传">断点续传</a></p></li> <li><p><code>setRange(long rangeStart, long rangeEnd)</code> 设置Range头信息，可用于<a href="/guide/updown.html#实现分块下载">分块下载</a></p></li> <li><p><code>bind(Object object)</code> 绑定一个对象，可用于实现Android里的<a href="/guide/android.html#生命周期绑定">生命周期绑定</a></p></li></ul> <h2 id="使用标签"><a href="#使用标签" class="header-anchor">#</a> 使用标签</h2> <p>有时候我们想对HTTP任务加以分类，这时候可以使用标签功能：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>http<span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">)</span>    <span class="token comment">//（1）</span>
        <span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
http<span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">)</span>    <span class="token comment">//（2）</span>
        <span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span><span class="token string">&quot;A.B&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
http<span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">)</span>    <span class="token comment">//（3）</span>
        <span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
http<span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">)</span>    <span class="token comment">//（4）</span>
        <span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span><span class="token string">&quot;C&quot;</span><span class="token punctuation">)</span>    <span class="token comment">// 从 v1.0.4 标签将以追加模式添加，等效于 setTag(&quot;B.C&quot;)</span>
        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
http<span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token string">&quot;/users&quot;</span><span class="token punctuation">)</span>    <span class="token comment">//（5）</span>
        <span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span><span class="token string">&quot;C&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>当使用标签后，就可以按标签批量的对HTTP任务进行取消：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> count <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token comment">//（2）（3）（4）被取消（取消标签包含&quot;B&quot;的任务）</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// 输出 3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>标签除了可以用来取消任务，在预处理器中它也可以发挥作用，请参见 <a href="/guide/configuration.html#并行预处理器">并行预处理器</a> 与 <a href="/guide/configuration.html#串行预处理器（token问题最佳解决方案）">串行预处理器（token问题最佳解决方案）</a>。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ejlchina/okhttps/edit/dev/docs/guide/foundation.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">4/28/2020, 7:52:32 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/" class="prev router-link-active">
        起步
      </a></span> <span class="next"><a href="/guide/configuration.html">
        配置
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.1e2fa6f5.js" defer></script><script src="/assets/js/2.16cbe9f2.js" defer></script><script src="/assets/js/11.152d132f.js" defer></script>
  </body>
</html>
